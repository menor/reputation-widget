// get facility-id from params
// Select svg based on browser language
// call the api for the feedback rating
// integrate the text in the svg
// change the color palette from a param
// contain globals into an object
// 'package' the code (base64 encoding of the svg?)

// globals (put this in an object)

// getting the language does not work
var lang = navigator.language || navigator.userLanguage

var palettes = {
  darkBlue: {
    medium: '#3E4862',
    dark: '#333B4F',
    darker: '#293140'
  },
  lightBlue: {
    medium: '#00A7C4',
    dark: '#018EA6',
    darker: '#047D92'
  },
  yellow: {
    medium: '#F8C150',
    dark: '#D7A43B',
    darker: '#B0842B'
  }
}

// Next 2 values should be passed as params
var facilityId = 'the-fish'
var palette = palettes.lightBlue

// Initialize function
function ready(fn) {
  if (document.readyState != 'loading'){
    fn();
  } else {
    document.addEventListener('DOMContentLoaded', fn);
  }
}

function replaceElement() {
  var el = document.getElementById('resmio-badge')
  // The svg should come from a file depending on the language
  // Still not sure how to do this, we can also put all the languages in the svg
  // and show or hide the elements through css
  el.innerHTML = (
    `
    <svg width="201" height="229" viewBox="0 0 201 229" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>
        <rect id="a" x="14.543" y="124.148" width="172.751" height="40.153" rx="2"/>
        <filter x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox" id="b">
          <feOffset dy="2" in="SourceAlpha" result="shadowOffsetOuter1"/>
          <feGaussianBlur stdDeviation="2" in="shadowOffsetOuter1" result="shadowBlurOuter1"/>
          <feComposite in="shadowBlurOuter1" in2="SourceAlpha" operator="out" result="shadowBlurOuter1"/>
          <feColorMatrix values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.149230072 0" in="shadowBlurOuter1"/>
        </filter>
        <mask id="c" x="0" y="0" width="172.751" height="40.153" fill="#fff">
          <use xlink:href="#a"/>
        </mask>
      </defs>
        <path id="scroll-torn" fill="${palette.dark}" d="M145.566 170.98l41.51-7.328H151.34m-93.217 7.432l-41.408-7.323 37.614.49"/>
        <path id="badge-back"  stroke="${palette.dark}" fill="${palette.medium}" d="M35.67 147.343C4.313 98.235 11.697 61.825 11.697 61.825l89.878-50.655 88.562 49.668s7.383 36.41-23.976 85.518c-31.35 49.108-65.14 70.45-65.14 70.45s-33.99-20.356-65.35-69.463z"/>
        <path id="badge-fill"  stroke="${palette.dark}" fill="#FFF" d="M43.537 142.9c-27.977-43.786-21.39-76.25-21.39-76.25l80.186-45.168 79.01 44.288s6.588 32.465-21.39 76.253c-27.976 43.79-58.948 62.81-58.948 62.81s-29.49-18.14-57.468-61.93z"/>
        <path id="legend-back" fill="${palette.darker}" d="M45.35 164.165l17.49 19.803h75.383l16.852-19.803"/>
        <path id="powered-by-resmio" fill="#FFF" d="M66.89 170.887c0 .636-.216 1.126-.65 1.468-.435.343-1.056.514-1.865.514h-.74v2.47h-.73v-6.29h1.63c1.57 0 2.356.61 2.356 1.83zm-3.254 1.354h.658c.647 0 1.116-.1 1.406-.31.29-.21.434-.54.434-1 0-.41-.136-.72-.41-.93-.27-.2-.695-.3-1.27-.3h-.818v2.56zm8.53.74c0 .77-.193 1.37-.58 1.8-.387.44-.922.65-1.604.65-.42 0-.795-.1-1.122-.29-.327-.19-.58-.48-.757-.85-.178-.37-.266-.8-.266-1.3 0-.76.192-1.36.576-1.79.384-.43.917-.64 1.6-.64.66 0 1.182.22 1.57.66.39.44.583 1.04.583 1.78zm-3.59 0c0 .61.12 1.06.36 1.38.242.32.596.48 1.063.48.46 0 .82-.15 1.06-.47.24-.31.36-.77.36-1.38 0-.59-.12-1.05-.37-1.36-.25-.31-.6-.46-1.08-.46-.47 0-.82.15-1.06.46-.24.31-.36.77-.36 1.37zm8.69 2.36l-.864-2.76c-.055-.17-.156-.55-.306-1.15h-.034c-.115.5-.215.89-.3 1.16l-.89 2.76h-.827l-1.285-4.71h.748l.694 2.71c.16.62.25 1.04.273 1.25h.035c.03-.16.082-.37.153-.63.07-.26.13-.46.182-.61l.864-2.7h.77l.84 2.71c.16.49.27.91.32 1.24h.03c.01-.1.04-.26.09-.47.05-.21.35-1.37.89-3.47h.74l-1.31 4.71h-.85zm4.992.09c-.697 0-1.246-.21-1.65-.63-.402-.42-.603-1.01-.603-1.76 0-.76.187-1.36.56-1.81.375-.45.878-.67 1.508-.67.59 0 1.058.2 1.402.58.344.39.516.9.516 1.54v.45h-3.24c.02.56.16.98.42 1.26.27.29.64.43 1.12.43.51 0 1.01-.1 1.51-.32v.64c-.25.11-.49.19-.71.24-.22.05-.49.07-.81.07zm-.193-4.28c-.38 0-.68.13-.906.37-.23.25-.36.59-.4 1.03h2.46c0-.45-.1-.79-.3-1.03-.2-.24-.49-.36-.86-.36zm5.293-.59c.21 0 .397.02.563.05l-.09.67c-.19-.04-.36-.06-.51-.06-.38 0-.7.16-.98.46-.27.31-.4.7-.4 1.16v2.53h-.71v-4.71h.59l.08.88h.04c.18-.31.39-.55.63-.71.25-.17.52-.25.82-.25zm3.435 4.89c-.696 0-1.246-.21-1.65-.63-.402-.42-.603-1.01-.603-1.76 0-.76.187-1.36.56-1.81.375-.45.878-.67 1.508-.67.59 0 1.058.2 1.402.58.344.39.516.9.516 1.54v.45H89.28c.014.56.154.98.42 1.26.264.29.637.43 1.12.43.506 0 1.008-.1 1.504-.32v.64c-.252.11-.49.19-.716.24-.225.05-.497.07-.815.07zm-.193-4.28c-.38 0-.68.13-.905.37-.225.25-.358.59-.398 1.03h2.464c0-.45-.1-.79-.3-1.03-.2-.24-.48-.36-.86-.36zm6.35 3.57h-.038c-.33.48-.823.72-1.48.72-.616 0-1.095-.21-1.438-.63-.342-.42-.514-1.02-.514-1.8s.172-1.38.516-1.81c.344-.43.823-.64 1.437-.64.64 0 1.13.24 1.47.7h.056l-.03-.34-.02-.33v-1.92h.71v6.69h-.58l-.1-.63zm-1.427.12c.487 0 .84-.13 1.06-.39.22-.26.33-.69.33-1.28V173c0-.67-.112-1.146-.335-1.43-.222-.286-.576-.43-1.064-.43-.418 0-.74.164-.96.49-.223.325-.334.784-.334 1.38 0 .6.11 1.054.33 1.36.222.307.546.46.973.46zm8.096-4.28c.62 0 1.1.22 1.44.64.34.43.51 1.02.51 1.8s-.18 1.38-.52 1.81c-.35.43-.83.65-1.44.65-.31 0-.59-.05-.84-.17-.26-.11-.47-.28-.64-.52h-.05l-.16.61h-.51v-6.69h.71v1.63c0 .36-.01.69-.04.98h.03c.33-.47.82-.7 1.48-.7zm-.11.6c-.49 0-.84.14-1.06.42-.22.28-.33.75-.33 1.42s.11 1.14.33 1.42c.22.29.57.43 1.06.43.44 0 .76-.16.98-.48.21-.32.32-.78.32-1.38 0-.61-.11-1.07-.32-1.37-.22-.3-.55-.45-1-.45zm2.56-.52h.76l1.03 2.69c.22.62.37 1.06.42 1.33h.03c.03-.14.11-.39.23-.75.12-.35.51-1.44 1.16-3.26h.76l-2.03 5.36c-.2.53-.44.91-.71 1.13-.27.22-.6.33-.99.33-.22 0-.43-.02-.65-.07v-.57c.16.04.34.05.53.05.49 0 .84-.27 1.05-.82l.26-.67-1.9-4.74zm9.62-.08c.21 0 .4.02.56.05l-.1.67c-.2-.04-.37-.06-.52-.06-.38 0-.71.16-.98.47-.27.31-.41.7-.41 1.16v2.53h-.71v-4.71h.59l.08.87h.03c.17-.31.38-.54.63-.71.24-.16.51-.25.81-.25zm3.43 4.89c-.7 0-1.25-.21-1.65-.63-.4-.42-.61-1.01-.61-1.76 0-.76.18-1.36.56-1.81.37-.45.87-.67 1.5-.67.59 0 1.06.19 1.4.58.34.39.51.9.51 1.54v.45h-3.24c.01.55.15.97.42 1.26.26.29.64.43 1.12.43.51 0 1.01-.11 1.5-.32v.64c-.26.11-.49.19-.72.24-.23.05-.5.07-.82.07zm-.2-4.28c-.38 0-.68.13-.91.37-.23.25-.36.59-.4 1.03h2.46c0-.45-.1-.79-.3-1.03-.2-.24-.49-.36-.86-.36zm6.18 2.92c0 .44-.17.78-.49 1.01-.33.24-.79.36-1.38.36-.63 0-1.12-.1-1.46-.29v-.66c.22.12.46.21.72.27.26.07.51.1.75.1.37 0 .66-.06.86-.18.2-.12.3-.3.3-.54 0-.18-.08-.34-.24-.47-.16-.13-.47-.28-.93-.46-.44-.16-.75-.3-.94-.43-.19-.12-.33-.26-.42-.41-.09-.16-.14-.34-.14-.56 0-.384.16-.69.47-.91.31-.22.74-.332 1.28-.332.51 0 1 .1 1.49.31l-.25.58c-.48-.2-.91-.3-1.29-.3-.34 0-.6.057-.77.16-.18.11-.26.256-.26.44 0 .13.03.24.09.328.06.09.17.18.31.26.14.08.42.2.83.35.56.2.93.41 1.13.616.19.21.29.47.29.78zm7.16 1.28v-3.06c0-.37-.08-.66-.24-.84-.16-.18-.41-.28-.75-.28-.44 0-.77.13-.98.38-.21.26-.32.65-.32 1.18v2.63h-.72v-3.07c0-.37-.08-.66-.24-.84-.16-.19-.41-.28-.75-.28-.45 0-.78.13-.99.4-.21.27-.32.71-.32 1.32v2.47h-.72v-4.71h.58l.11.64h.04c.13-.23.32-.41.57-.54.24-.13.52-.19.82-.19.73 0 1.22.27 1.44.8h.03c.14-.24.34-.44.61-.58.26-.15.57-.22.91-.22.53 0 .93.14 1.19.41.26.28.4.718.4 1.32v3.076h-.72zm2.9 0h-.71v-4.71h.71v4.71zm-.78-5.99c0-.16.04-.28.12-.36.08-.07.18-.11.3-.11.11 0 .21.04.3.12.08.08.12.2.12.36 0 .16-.04.28-.12.36-.09.08-.19.12-.3.12-.12 0-.22-.04-.3-.12-.08-.08-.12-.2-.12-.36zm6.35 3.63c0 .77-.19 1.37-.58 1.8-.39.43-.92.65-1.61.65-.42 0-.8-.1-1.12-.3-.33-.19-.58-.48-.76-.85-.18-.37-.27-.8-.27-1.3 0-.76.19-1.36.57-1.79.38-.43.91-.64 1.6-.64.66 0 1.18.22 1.57.66.39.44.58 1.04.58 1.78zm-3.59 0c0 .6.12 1.06.36 1.38.24.31.59.47 1.06.47.47 0 .82-.16 1.06-.47.24-.31.36-.77.36-1.38 0-.6-.12-1.05-.37-1.36-.247-.31-.6-.46-1.077-.46-.47 0-.82.15-1.06.46-.24.3-.36.76-.36 1.37z"/>
        <use fill="#000" filter="url(#b)" xlink:href="#a"/>
        <use fill="${palette.medium}" stroke="${palette.dark}" mask="url(#c)" stroke-width="2" xlink:href="#a"/>
        <path fill="${palette.medium}" d="M121.003 63.53H78.08c-3.19 0-2.706 3.485 1.418 3.485h43.955c4.123 0 4.22-3.485 1.417-3.485h-3.867z"/>
        <path d="M106.475 42.542c.445-.486.74-1.1.8-1.802.15-1.717-1.136-3.225-2.874-3.377-1.73-.152-3.26 1.12-3.41 2.835-.06.703.13 1.348.48 1.904-10.81.365-20.04 10.24-20.67 17.5l43.02 3.764c.64-7.26-6.74-18.587-17.32-20.824" fill="#DDD"/>
        <path d="M117.808 57.225c-1.743-4.045-5.163-7.707-9.386-10.046-.56-.31-.76-1.01-.446-1.56.313-.56 1.02-.75 1.58-.44 4.66 2.58 8.447 6.64 10.386 11.15.25.58-.023 1.25-.613 1.5-.17.07-.35.1-.52.09-.43-.03-.83-.28-1.01-.7z" fill="#FFF"/>
        <text  fill="#FFF" font-family="Open Sans" font-size="21.615" font-weight="300" letter-spacing=".5" >
          <tspan x="32.0343862" y="152">90</tspan>
          <tspan x="56.7096495" y="152" font-size="18">%</tspan>
          <tspan x="78.2223448" y="152"> POSITIVE</tspan>
        </text>
        <text fill="${palette.darker}" font-family="Open Sans" font-size="12.5" letter-spacing=".439">
          <tspan x="47" y="96">SATISFACTION OF</tspan>
          <tspan x="61.247" y="115.5">OUR GUESTS</tspan>
        </text>
    </svg>
  `
  )
}

function getFeedbackScore(cb) {
  // This needs to call the feedback score API endpoint instead
  var req = makeCORSRequest('https://api.resmio.com/v1/facility/' + facilityId + '/availability?date__gte=2016-03-01')
  req.onload = function onload() {
    if (req.status === 404) {
      return new Error('not found')
    } else {
      cb(req.response)
    }
  }
  req.send()
}

// Adapted from the third party JS book
function makeCORSRequest(url) {
  if (typeof XMLHttpRequest === "undefined") {
    return null;
  }

  var xhr = new XMLHttpRequest()
  if ("withCredentials" in xhr) {                    // Browsers supporting CORS
    xhr.open('GET', url, true)
  }
  else if (typeof XDomainRequest !== "undefined") {  // IE with CORS support
    xhr = new XDomainRequest();
    xhr.open('GET', url);
  }
  else {                                             // No CORS support
    xhr = null
  }
  return xhr;
}

function initialize() {
  getFeedbackScore(function(res) { console.log(res) })
  replaceElement()
}

ready(initialize)
